<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª | Ø§ÛŒØ±Ø§Ù† ÙˆØ§Ø¨ÛŒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Vazir', sans-serif; background-color: #f8f9fa; }
    header {
      background: linear-gradient(135deg, #ff0000, #923c3c);
      color: #fff;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .order-card {
      background-color: white;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .btn-control { margin-left: 0.5rem; }
    .dashboard { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
    .dashboard .card { flex: 1 1 250px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    canvas { max-width: 100% !important; }
  </style>
</head>
<body>

<header>
  <h1><i class="bi bi-list-check me-2"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</h1>
  <button id="logoutBtn" class="btn btn-light">Ø®Ø±ÙˆØ¬</button>
</header>

<main class="container my-4">

  <section class="dashboard">
    <div class="card p-3">
      <h5>ğŸ“¦ Ù…Ø¬Ù…ÙˆØ¹ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h5>
      <p id="totalOrders">0</p>
    </div>
    <div class="card p-3">
      <h5>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</h5>
      <canvas id="statusChart" height="180"></canvas>
    </div>
    <div class="card p-3">
      <h5>ğŸ”¥ Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† Ù…Ø­ØµÙˆÙ„</h5>
      <p id="topProduct">â€”</p>
    </div>
  </section>

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <input type="text" id="searchInput" class="form-control w-25" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
    <select id="statusFilter" class="form-select w-auto">
      <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
      <option value="Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</option>
      <option value="Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
      <option value="Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
      <option value="Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡">Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡</option>
      <option value="Ù„ØºÙˆ Ø´Ø¯Ù‡">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
    </select>
    <div>
      <button class="btn btn-success btn-control" onclick="exportToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Excel</button>
      <button class="btn btn-danger btn-control" onclick="exportToPDF()">Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
      <button class="btn btn-primary btn-control" data-bs-toggle="modal" data-bs-target="#manualOrderModal">Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙØ§Ø±Ø´</button>
    </div>
  </div>

  <section id="orders"></section>
</main>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÛŒ Ø³ÙØ§Ø±Ø´ -->
<div class="modal fade" id="manualOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙØ§Ø±Ø´ Ø¯Ø³ØªÛŒ</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="manualOrderForm">
        <input type="text" class="form-control mb-2" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ" required id="manualName">
        <input type="text" class="form-control mb-2" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" required id="manualPhone">
        <input type="text" class="form-control mb-2" placeholder="Ø¢Ø¯Ø±Ø³ Ù…ØºØ§Ø²Ù‡" required id="manualAddress">
        <textarea class="form-control mb-2" placeholder="Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù…Ø«Ù„Ø§Ù‹: Ú©Ø§Ø¨Ù„ Ø¢ÛŒÙÙˆÙ† 3 Ø¹Ø¯Ø¯)" required id="manualProducts"></textarea>
        <button type="submit" class="btn btn-success w-100">Ø§ÙØ²ÙˆØ¯Ù†</button>
      </form>
    </div>
  </div></div>
</div>

<script>
const ordersContainer = document.getElementById("orders");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");

let orders = JSON.parse(localStorage.getItem("orders")) || [];
orders = orders.map(o => ({ ...o, status: o.status || "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ" }));

function renderOrders() {
  const search = searchInput.value.trim();
  const filter = statusFilter.value;
  const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));

  const filtered = orders.filter(order => {
    const matchSearch = order.name.includes(search) || order.phone.includes(search) || order.shopAddress.includes(search);
    const matchStatus = !filter || order.status === filter;
    const matchUser = !currentUser || currentUser.mobile === order.phone; // ÙÙ‚Ø· Ø³ÙØ§Ø±Ø´Ø§Øª Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡
    return matchSearch && matchStatus && (currentUser?.role === "Ù…Ø¯ÛŒØ±" ? true : matchUser);
  });

  ordersContainer.innerHTML = filtered.length === 0
    ? `<div class="alert alert-warning">Ø³ÙØ§Ø±Ø´ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>`
    : filtered.map((order, i) => `
      <div class="order-card">
        <div class="d-flex justify-content-between">
          <h5>Ø³ÙØ§Ø±Ø´ ${i + 1}</h5>
          <span class="badge ${getStatusBadge(order.status)}">${order.status}</span>
        </div>
        <p><strong>Ù†Ø§Ù…:</strong> ${order.name}</p>
        <p><strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</strong> ${order.phone}</p>
        <p><strong>Ø¢Ø¯Ø±Ø³:</strong> ${order.shopAddress}</p>
        <ul>${order.products.map(p => `<li>${p.name} (${p.quantity} Ø¹Ø¯Ø¯)</li>`).join('')}</ul>
        ${currentUser?.mobile === order.phone || currentUser?.role === "Ù…Ø¯ÛŒØ±" ? `
        <div class="mt-3">
          <label>ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª:</label>
          ${["Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ", "Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…", "Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡", "Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡", "Ù„ØºÙˆ Ø´Ø¯Ù‡"].map(s =>
            `<button class="btn btn-sm btn-outline-${statusColor(s)} me-1" onclick="changeStatus(${i}, '${s}')">${s}</button>`
          ).join('')}
        </div>` : ''}
      </div>
    `).join("");
}

function renderDashboard() {
  document.getElementById("totalOrders").innerText = orders.length;

  const statusCounts = orders.reduce((acc, o) => {
    acc[o.status] = (acc[o.status] || 0) + 1;
    return acc;
  }, {});

  const topItem = {};
  orders.forEach(o => {
    o.products.forEach(p => {
      const name = p.name || p;
      topItem[name] = (topItem[name] || 0) + (p.quantity || 1);
    });
  });

  const top = Object.entries(topItem).sort((a, b) => b[1] - a[1])[0];
  document.getElementById("topProduct").innerText = top ? `${top[0]} (${top[1]} Ø¹Ø¯Ø¯)` : "â€”";

  const ctx = document.getElementById("statusChart").getContext("2d");
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(statusCounts),
      datasets: [{
        data: Object.values(statusCounts),
        backgroundColor: ["#ffc107", "#0dcaf0", "#0d6efd", "#198754", "#dc3545"]
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
}

renderDashboard();

function getStatusBadge(status) {
  const map = {
    "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ": "bg-warning text-dark",
    "Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…": "bg-info",
    "Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡": "bg-primary",
    "Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡": "bg-success",
    "Ù„ØºÙˆ Ø´Ø¯Ù‡": "bg-danger"
  };
  return map[status] || "bg-secondary";
}

function statusColor(status) {
  return {
    "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ": "warning",
    "Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…": "info",
    "Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡": "primary",
    "Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡": "success",
    "Ù„ØºÙˆ Ø´Ø¯Ù‡": "danger"
  }[status] || "secondary";
}

function changeStatus(index, newStatus) {
  orders[index].status = newStatus;
  localStorage.setItem("orders", JSON.stringify(orders));
  renderOrders();
}

searchInput.addEventListener("input", renderOrders);
statusFilter.addEventListener("change", renderOrders);

document.getElementById("logoutBtn").addEventListener("click", () => {
  alert("âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.");
  window.location.href = "index.html";
});

document.getElementById("manualOrderForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const name = document.getElementById("manualName").value.trim();
  const phone = document.getElementById("manualPhone").value.trim();
  const address = document.getElementById("manualAddress").value.trim();
  const productsRaw = document.getElementById("manualProducts").value.trim();

  const products = productsRaw.split('\n').map(line => {
    const parts = line.split(' ');
    return { name: parts.slice(0, -1).join(' '), quantity: parseInt(parts.at(-1)) || 1 };
  });

  orders.push({ name, phone, shopAddress: address, products, status: "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ" });
  localStorage.setItem("orders", JSON.stringify(orders));
  renderOrders();

  e.target.reset();
  bootstrap.Modal.getInstance(document.getElementById("manualOrderModal")).hide();
});

// Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„
function exportToExcel() {
  const ws = XLSX.utils.json_to_sheet(orders.map(o => ({
    Ù†Ø§Ù…: o.name,
    Ø´Ù…Ø§Ø±Ù‡: o.phone,
    Ø¢Ø¯Ø±Ø³: o.shopAddress,
    ÙˆØ¶Ø¹ÛŒØª: o.status,
    Ù…Ø­ØµÙˆÙ„Ø§Øª: o.products.map(p => `${p.name || p} (${p.quantity || 1})`).join(" - ")
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ø³ÙØ§Ø±Ø´Ø§Øª");
  XLSX.writeFile(wb, "orders.xlsx");
}

// Ø®Ø±ÙˆØ¬ÛŒ PDF
async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFont("Vazir");
  doc.setFontSize(12);

  orders.forEach((o, i) => {
    doc.text(`Ø³ÙØ§Ø±Ø´ ${i + 1}`, 10, 10 + i * 40);
    doc.text(`Ù†Ø§Ù…: ${o.name}`, 10, 15 + i * 40);
    doc.text(`ØªÙ„ÙÙ†: ${o.phone}`, 10, 20 + i * 40);
    doc.text(`Ø¢Ø¯Ø±Ø³: ${o.shopAddress}`, 10, 25 + i * 40);
    doc.text(`ÙˆØ¶Ø¹ÛŒØª: ${o.status}`, 10, 30 + i * 40);
    doc.text(`Ù…Ø­ØµÙˆÙ„Ø§Øª: ${o.products.map(p => `${p.name || p} (${p.quantity || 1})`).join(', ')}`, 10, 35 + i * 40);
  });

  doc.save("orders.pdf");
}

renderOrders();
</script>

</body>
</html>
