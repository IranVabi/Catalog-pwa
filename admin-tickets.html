<!-- admin-tickets.html Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡ -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ | Ø§ÛŒØ±Ø§Ù† ÙˆØ§Ø¨ÛŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Vazir', sans-serif;
      background-color: #f8f9fa;
    }
    header {
      background: linear-gradient(135deg, #ff0000, #926c6c);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dashboard {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 2rem 0;
    }
    .dashboard .card {
      flex: 1 1 250px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 1rem;
    }
    .ticket-card {
      background-color: white;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

<header>
  <h1><i class="bi bi-chat-dots me-2"></i> Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</h1>
  <button id="logoutBtn" class="btn btn-light">Ø®Ø±ÙˆØ¬</button>
</header>

<main class="container">

  <section class="dashboard">
    <div class="card">
      <h5>ğŸ“¨ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</h5>
      <p id="totalTickets">0</p>
    </div>
    <div class="card">
      <h5>ğŸ‘¤ Ø§Ø±Ø³Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡ ÙØ¹Ø§Ù„</h5>
      <p id="topSender">â€”</p>
    </div>
    <div class="card">
      <h5>ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø± Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§</h5>
      <canvas id="ticketChart" height="150"></canvas>
    </div>
  </section>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</h2>
    <input type="text" id="searchInput" class="form-control w-50" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÛŒÚ©Øªâ€ŒÙ‡Ø§...">
  </div>

  <div id="tickets"></div>

</main>

<script>
  const ticketsContainer = document.getElementById("tickets");
  const logoutBtn = document.getElementById("logoutBtn");
  const searchInput = document.getElementById("searchInput");

  let tickets = JSON.parse(localStorage.getItem("tickets")) || [];
  const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));

  function renderTickets(filter = "") {
    if (tickets.length === 0) {
      ticketsContainer.innerHTML = `
        <div class="alert alert-warning text-center">
          Ù‡ÛŒÚ† ØªÛŒÚ©ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
        </div>`;
      return;
    }

    const filtered = tickets.filter(ticket => {
      const matchSearch = ticket.name.includes(filter) || ticket.subject.includes(filter) || ticket.message.includes(filter);
      const matchUser = currentUser?.role === "Ù…Ø¯ÛŒØ±" || ticket.name === currentUser?.fullName;
      return matchSearch && matchUser;
    });

    ticketsContainer.innerHTML = "";

    filtered.forEach((ticket, index) => {
      ticketsContainer.innerHTML += `
        <div class="ticket-card">
          <h5><i class="bi bi-envelope-open me-1"></i> ØªÛŒÚ©Øª Ø´Ù…Ø§Ø±Ù‡ ${index + 1}</h5>
          <p><strong>Ù†Ø§Ù…:</strong> ${ticket.name}</p>
          <p><strong>Ù…ÙˆØ¶ÙˆØ¹:</strong> ${ticket.subject}</p>
          <p><strong>Ù¾ÛŒØ§Ù…:</strong> ${ticket.message}</p>
          <p><strong>ØªØ§Ø±ÛŒØ®:</strong> ${ticket.date}</p>
        </div>
      `;
    });
  }

  function renderDashboard() {
    document.getElementById("totalTickets").innerText = tickets.length;

    const senders = tickets.reduce((acc, t) => {
      acc[t.name] = (acc[t.name] || 0) + 1;
      return acc;
    }, {});

    const top = Object.entries(senders).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById("topSender").innerText = top ? `${top[0]} (${top[1]})` : "â€”";

    const chartCtx = document.getElementById("ticketChart").getContext("2d");
    new Chart(chartCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(senders),
        datasets: [{
          label: 'ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§',
          data: Object.values(senders),
          backgroundColor: '#ff4d4d'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function renderTickets(filter = "") {
    const filtered = tickets.filter(ticket => {
      const matchSearch = ticket.name.includes(filter) || ticket.subject.includes(filter) || ticket.message.includes(filter);
      const matchUser = currentUser?.role === "Ù…Ø¯ÛŒØ±" || ticket.name === currentUser?.fullName;
      return matchSearch && matchUser;
    });

    ticketsContainer.innerHTML = filtered.length === 0
      ? `<div class="alert alert-warning text-center">ØªÛŒÚ©ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>`
      : filtered.map((ticket, index) => `
          <div class="ticket-card">
            <h5><i class="bi bi-envelope me-1"></i> ØªÛŒÚ©Øª ${index + 1}</h5>
            <p><strong>Ù†Ø§Ù…:</strong> ${ticket.name}</p>
            <p><strong>Ù…ÙˆØ¶ÙˆØ¹:</strong> ${ticket.subject}</p>
            <p><strong>Ù¾ÛŒØ§Ù…:</strong> ${ticket.message}</p>
            <p><strong>ØªØ§Ø±ÛŒØ®:</strong> ${ticket.date}</p>
          </div>`).join("");
  }

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("loggedInUser");
    alert("Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯");
    window.location.href = "index.html";
  });

  searchInput.addEventListener("input", () => renderTickets(searchInput.value.trim()));

  renderDashboard();
  renderTickets();

  searchInput.addEventListener("input", () => {
    renderTickets(searchInput.value.trim());
  });

  logoutBtn.addEventListener("click", () => {
    alert("âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.");
    window.location.href = "index.html";
  });

  renderTickets();
</script>

</body>
</html>